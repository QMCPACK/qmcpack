

INCLUDE("${PROJECT_SOURCE_DIR}/CMake/test_labels.cmake")

# Add tests for conversion of GAMESS to QMCPACK input (via convert4qmc)

FUNCTION(ADD_CONVERTER_TEST test_name)
    EXECUTE_PROCESS(COMMAND ${CMAKE_COMMAND} -E copy_directory "${CMAKE_CURRENT_SOURCE_DIR}/${test_name}" "${CMAKE_CURRENT_BINARY_DIR}/${test_name}")
    SET(EXE_NAME "${qmcpack_BINARY_DIR}/bin/convert4qmc")
    IF ( HAVE_MPI )
        SET(EXE_NAME ${MPIEXEC_EXECUTABLE} ${MPIEXEC_NUMPROC_FLAG} 1 ${MPIEXEC_PREFLAGS} ${qmcpack_BINARY_DIR}/bin/convert4qmc)
        STRING(REPLACE ";" " " EXE_NAME "${EXE_NAME}")
    ENDIF()
    ADD_TEST(NAME converter_${test_name} COMMAND "${CMAKE_CURRENT_BINARY_DIR}/converter_test.py" "${CMAKE_CURRENT_BINARY_DIR}/${test_name}" --exe "${EXE_NAME}" --h5diff "${HDF5_DIFF_EXECUTABLE}")
    SET_TESTS_PROPERTIES(converter_${test_name} PROPERTIES TIMEOUT 120 LABELS "converter")
ENDFUNCTION()

FUNCTION(ADD_PWCONVERTER_TEST test_name)
    EXECUTE_PROCESS(COMMAND ${CMAKE_COMMAND} -E copy_directory "${CMAKE_CURRENT_SOURCE_DIR}/${test_name}" "${CMAKE_CURRENT_BINARY_DIR}/${test_name}")
    SET(EXE_NAME "${qmcpack_BINARY_DIR}/bin/convertpw4qmc")
    ADD_TEST(NAME converter_${test_name} COMMAND "${CMAKE_CURRENT_BINARY_DIR}/pwconverter_test.py" "${CMAKE_CURRENT_BINARY_DIR}/${test_name}" --exe "${EXE_NAME}" --h5diff "${HDF5_DIFF_EXECUTABLE}")
    SET_TESTS_PROPERTIES(converter_${test_name} PROPERTIES TIMEOUT 120 LABELS "converter")
ENDFUNCTION()

EXECUTE_PROCESS(COMMAND ${CMAKE_COMMAND} -E copy "${CMAKE_CURRENT_SOURCE_DIR}/converter_test.py" "${CMAKE_CURRENT_BINARY_DIR}")
ADD_CONVERTER_TEST(test_He_sto3g)
ADD_CONVERTER_TEST(test_Be_sto3g)
ADD_CONVERTER_TEST(test_Be_ccd)
ADD_CONVERTER_TEST(test_O_ext)
ADD_CONVERTER_TEST(test_C_sto3g)
ADD_CONVERTER_TEST(test_HCNp)
ADD_CONVERTER_TEST(test_aldet1)
ADD_CONVERTER_TEST(test_aldet5)
ADD_CONVERTER_TEST(test_aldet6)
IF (HDF5_DIFF_EXECUTABLE)
  ADD_CONVERTER_TEST(test_HDF5_FeCO6)
  ADD_CONVERTER_TEST(test_HDF5_Be_ccd)
  EXECUTE_PROCESS(COMMAND ${CMAKE_COMMAND} -E copy "${CMAKE_CURRENT_SOURCE_DIR}/pwconverter_test.py" "${CMAKE_CURRENT_BINARY_DIR}") 
  ADD_PWCONVERTER_TEST(test_NaCl_qbox)
  ADD_PWCONVERTER_TEST(test_O2_pwscf)
  SET(H5_REF ${qmcpack_SOURCE_DIR}/tests/solids/monoO_noncollinear_1x1x1_pp/o2_45deg_spins.pwscf.h5)
  MAYBE_SYMLINK(${H5_REF} ${CMAKE_CURRENT_BINARY_DIR}/test_O2_pwscf/gold.h5)
ELSE()
  MESSAGE("Skipping converter tests with HDF output because h5diff was not found")
ENDIF()
ADD_CONVERTER_TEST(test_LiH_pyscf)
ADD_CONVERTER_TEST(test_LiH_pyscf_UHF)
ADD_CONVERTER_TEST(test_LiH_qp)
ADD_CONVERTER_TEST(test_C4_MSD_excited)
