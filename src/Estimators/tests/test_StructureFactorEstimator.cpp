//////////////////////////////////////////////////////////////////////////////////////
// This file is distributed under the University of Illinois/NCSA Open Source License.
// See LICENSE file in top directory for details.
//
// Copyright (c) 2024 QMCPACK developers.
//
// File developed by: Peter Doak, doakpw@ornl.gov, Oak Ridge National Lab
//
// File created by: Peter Doak, doakpw@ornl.gov, Oak Ridge National Lab
//////////////////////////////////////////////////////////////////////////////////////

#include "catch.hpp"

#include "StructureFactorEstimator.h"
#include "ValidStructureFactorInput.h"
#include "Particle/tests/MinimalParticlePool.h"
#include "QMCWaveFunctions/tests/MinimalWaveFunctionPool.h"
#include "RandomForTest.h"
#include "GenerateRandomParticleSets.h"
#include "Utilities/ProjectData.h"
#include "Utilities/for_testing/NativeInitializerPrint.hpp"
#include "Utilities/for_testing/checkVector.hpp"
#include <iostream>

namespace qmcplusplus
{

constexpr bool generate_test_data = false;

namespace testing
{
class StructureFactorAccess
{
  using Real = StructureFactorEstimator::Real;

public:
  const Vector<Real>& getSKElecElec(const StructureFactorEstimator& sfe) const { return sfe.getSKElecElec(); }
  const Vector<std::complex<Real>>& getRhoKElec(const StructureFactorEstimator& sfe) const { return sfe.getRhoKElec(); }
};
} // namespace testing

/// Provides the canned test data for testing
class StructureFactorTests
{
  using Real  = StructureFactorEstimator::Real;
  using Data  = Vector<Real>;
  using DataC = Vector<std::complex<Real>>;

public:
  static Data getSKElecElec();
  static DataC getRhoKElec();
};

TEST_CASE("StructureFactorEstimator::StructureFactorEstimator", "[estimators]")
{
  using Input = qmcplusplus::testing::ValidStructureFactorInput;
  Communicate* comm;
  comm = OHMMS::Controller;

  ParticleSetPool particle_pool{MinimalParticlePool::make_diamondC_1x1x1(comm)};

  ParticleSet pset_elec{*(particle_pool.getParticleSet("e"))};
  ParticleSet pset_ions{*(particle_pool.getParticleSet("ion"))};

  pset_elec.R =
      ParticleSet::ParticlePos{{1.451870349, 1.381521229, 1.165202269}, {1.244515371, 1.382273176, 1.21105285},
                               {0.000459944, 1.329603408, 1.265030556}, {0.748660329, 1.63420622, 1.393637791},
                               {0.033228526, 1.391869137, 0.654413566}, {1.114198787, 1.654334594, 0.231075822},
                               {1.657151589, 0.883870516, 1.201243939}, {0.97317591, 1.245644974, 0.284564732}};

  Libxml2Document doc;
  bool okay       = doc.parseFromString(Input::xml[Input::valid::SKALL]);
  xmlNodePtr node = doc.getRoot();
  UPtr<StructureFactorInput> sf_in;
  sf_in = std::make_unique<StructureFactorInput>(node);
  StructureFactorEstimator sfe(*sf_in, pset_ions, pset_elec);
}

TEST_CASE("StructureFactorEstimator::Accumulate", "[estimators]")
{
  using Input = qmcplusplus::testing::ValidStructureFactorInput;
  Communicate* comm;
  comm = OHMMS::Controller;

  Libxml2Document doc;
  bool okay       = doc.parseFromString(Input::xml[Input::valid::SKALL]);
  xmlNodePtr node = doc.getRoot();
  UPtr<StructureFactorInput> sf_in;
  sf_in = std::make_unique<StructureFactorInput>(node);

  ParticleSetPool particle_pool{MinimalParticlePool::make_diamondC_1x1x1(comm)};

  ParticleSet pset_elec{*(particle_pool.getParticleSet("e"))};
  ParticleSet pset_ions{*(particle_pool.getParticleSet("ion"))};

  StructureFactorEstimator sfe(*sf_in, pset_ions, pset_elec);

  std::vector<OperatorEstBase::MCPWalker> walkers;
  int nwalkers = 3;
  for (int iw = 0; iw < nwalkers; ++iw)
    walkers.emplace_back(8);

  std::vector<ParticleSet::ParticlePos> deterministic_rs = {
      {
          {0.5156778693, 0.9486072659, -1.174232483},
          {-0.3166678548, 1.376550555, 1.445290089},
          {1.960713625, 2.472656727, 1.051449418},
          {0.7458532453, 0.5551358461, 4.080774784},
          {-0.3515016139, -0.5192222595, 0.9941511154},
          {-0.8354426622, 0.7071638107, -0.3409843445},
          {0.4386044741, 1.237378716, 2.331874132},
          {2.125850677, 0.322106719, 0.5825730562},
      },
      {
          {-0.4633736908, 0.06318772584, -0.8580153584},
          {-1.1749264, -0.6276503801, 0.07458759099},
          {1.327618122, 2.085829258, 1.415749788},
          {0.9114726782, 0.1789183617, -0.08135545254},
          {-2.267908812, 0.8029287457, 0.9522812963},
          {1.50271523, -1.844935298, 0.2805620432},
          {3.168934584, 0.1348338127, 1.371092796},
          {0.8310229182, 1.070827127, 1.180167317},
      },
      {
          {-0.04847732186, -1.201739907, -1.700527787},
          {0.1589259505, -0.3096047044, -2.06662631},
          {2.2559762, 1.62913239, -0.8024448156},
          {2.5347929, 3.121092796, 1.609780669},
          {-0.2892376184, -0.1520225108, -2.727613688},
          {0.2477154732, 0.5039232969, 2.995702744},
          {3.679345131, 3.037770271, 2.808899403},
          {0.6418578625, 1.935944557, 1.515637875},
      },
  };
  std::vector<ParticleSet> psets =
      testing::generateRandomParticleSets(pset_elec, pset_ions, deterministic_rs, nwalkers, generate_test_data);

  auto ref_walkers = makeRefVector<OperatorEstBase::MCPWalker>(walkers);
  auto ref_psets   = makeRefVector<ParticleSet>(psets);

  ProjectData test_project("test", ProjectData::DriverVersion::BATCH);

  auto wavefunction_pool =
      MinimalWaveFunctionPool::make_diamondC_1x1x1(test_project.getRuntimeOptions(), comm, particle_pool);
  auto& spomap = wavefunction_pool.getWaveFunction("wavefunction")->getSPOMap();

  auto& trial_wavefunction = *(wavefunction_pool.getPrimary());
  std::vector<UPtr<TrialWaveFunction>> twfcs(nwalkers);
  for (int iw = 0; iw < nwalkers; ++iw)
    twfcs[iw] = trial_wavefunction.makeClone(psets[iw]);

  // These are just empty arguments to hang the accumulation test, StructureFactorEstimator never accesses into them.
  // In the application the estimator manager calls accumulate and all these vectors are really populated.
  std::vector<QMCHamiltonian> hams;
  auto ref_wfns = convertUPtrToRefVector(twfcs);
  auto ref_hams = makeRefVector<QMCHamiltonian>(hams);

  FakeRandom<OHMMS_PRECISION_FULL> rng;

  auto updateWalker = [](auto& walker, auto& pset_target, auto& trial_wavefunction) {
    pset_target.update(true);
    pset_target.donePbyP();
    trial_wavefunction.evaluateLog(pset_target);
    //pset_target.saveWalker(walker);
  };

  for (int iw = 0; iw < nwalkers; ++iw)
    updateWalker(walkers[iw], psets[iw], *(twfcs[iw]));

  using QMCT = OperatorEstBase::QMCT;
  std::vector<QMCT::RealType> rng_reals(nwalkers * QMCT::DIM * 2);
  testing::RandomForTest<QMCT::RealType> rft;
  rft.fillVecRng(rng_reals);
  auto it_rng_reals = rng_reals.begin();
  for (ParticleSet& pset : psets)
  {
    pset.R[0] = ParticleSet::PosType(*it_rng_reals++, *it_rng_reals++, *it_rng_reals++);
    pset.R[1] = ParticleSet::PosType(*it_rng_reals++, *it_rng_reals++, *it_rng_reals++);
  }
  for (int iw = 0; iw < nwalkers; ++iw)
    updateWalker(walkers[iw], psets[iw], *(twfcs[iw]));

  CHECK(sfe.getNumKPoints() == 608);

  sfe.accumulate(ref_walkers, ref_psets, ref_wfns, ref_hams, rng);

  testing::StructureFactorAccess sfa;
  auto& sfk_e_e = sfa.getSKElecElec(sfe);
  auto& rhok_e  = sfa.getRhoKElec(sfe);

  if constexpr (generate_test_data)
  {
    std::cout << "sfk_e_e_exected = ";
    std::cout << NativePrint(sfk_e_e) << '\n';
    std::cout << "rhok_e_expected = ";
    std::cout << NativePrint(rhok_e) << '\n';
    FAIL_CHECK("Test always fails when generating new test reference data.");
  }
  auto sfk_e_e_expected = StructureFactorTests::getSKElecElec();
  auto rhok_e_expected  = StructureFactorTests::getRhoKElec();

  {
    INFO("In sfk_e_e test");
    auto check = checkVector(sfk_e_e_expected, sfk_e_e, true, 2e-6);
    CHECKED_ELSE(check.result) { FAIL(check.result_message); }
  }
  {
    INFO("In rhok_e test");
    auto check = checkVector(rhok_e_expected, rhok_e, true, 2e-6);
    CHECKED_ELSE(check.result) { FAIL(check.result_message); }
  }
}

typename StructureFactorTests::Data StructureFactorTests::getSKElecElec()
{
  Data sfk_e_e_expected = {
      19.73622409, 19.85599833, 13.72912952, 18.7567436,  18.7567436,  13.72912952,  19.85599833,  19.73622409,
      32.80349613, 43.77882488, 33.19361518, 33.19361518, 43.77882488, 32.80349613,  11.48587142,  46.64709949,
      13.93536133, 21.81977173, 16.97146535, 49.03789794, 49.03789794, 16.97146535,  21.81977173,  13.93536133,
      46.64709949, 11.48587142, 15.27185108, 15.26608063, 27.7955367,  34.77712919,  50.21756277,  48.46034073,
      13.67208302, 15.2759003,  24.9735954,  51.96621083, 10.82582644, 13.76046803,  13.76046803,  10.82582644,
      51.96621083, 24.9735954,  15.2759003,  13.67208302, 48.46034073, 50.21756277,  34.77712919,  27.7955367,
      15.26608063, 15.27185108, 16.81093491, 29.33480016, 5.102482939, 85.84144848,  85.84144848,  5.102482939,
      29.33480016, 16.81093491, 25.95727893, 34.50158877, 21.52643825, 21.52643825,  34.50158877,  25.95727893,
      35.0579667,  19.39619013, 38.54357824, 36.68959067, 16.29642718, 41.76596521,  39.29202881,  40.27941228,
      43.67495005, 17.53615809, 17.01120462, 14.28325607, 14.28325607, 17.01120462,  17.53615809,  43.67495005,
      40.27941228, 39.29202881, 41.76596521, 16.29642718, 36.68959067, 38.54357824,  19.39619013,  35.0579667,
      8.223339002, 16.57196508, 16.75862604, 39.18903305, 28.35930877, 14.97254748,  11.20260284,  12.45507276,
      23.81349352, 35.41850957, 6.749878719, 6.768163411, 6.768163411, 6.749878719,  35.41850957,  23.81349352,
      12.45507276, 11.20260284, 14.97254748, 28.35930877, 39.18903305, 16.75862604,  16.57196508,  8.223339002,
      23.82761065, 13.7042595,  37.05511444, 20.61174859, 28.73698196, 29.0746151,   13.5557756,   28.73126723,
      50.90294826, 12.75067342, 37.09167578, 21.69446229, 21.69446229, 37.09167578,  12.75067342,  50.90294826,
      28.73126723, 13.5557756,  29.0746151,  28.73698196, 20.61174859, 37.05511444,  13.7042595,   23.82761065,
      13.79165031, 20.25505287, 20.8287929,  22.74308659, 11.19786182, 18.27315154,  11.80154324,  12.47373847,
      41.87594528, 15.71940179, 18.91372254, 12.80999006, 47.60127717, 32.10045328,  23.97351432,  19.95431406,
      19.95431406, 23.97351432, 32.10045328, 47.60127717, 12.80999006, 18.91372254,  15.71940179,  41.87594528,
      12.47373847, 11.80154324, 18.27315154, 11.19786182, 22.74308659, 20.8287929,   20.25505287,  13.79165031,
      26.96515273, 32.77269551, 19.30793995, 26.1677214,  21.83952133, 12.22078605,  12.22078605,  21.83952133,
      26.1677214,  19.30793995, 32.77269551, 26.96515273, 27.08095415, 38.00550997,  44.88177241,  23.56671608,
      15.25416206, 27.14280968, 24.70110386, 26.94975025, 18.18262047, 41.78519622,  25.52964636,  12.35083128,
      23.92583602, 29.39852083, 22.78664347, 17.16173283, 14.08821999, 23.29167092,  43.20002531,  7.741713406,
      30.15170718, 34.6554293,  16.8723902,  20.67639441, 20.67639441, 16.8723902,   34.6554293,   30.15170718,
      7.741713406, 43.20002531, 23.29167092, 14.08821999, 17.16173283, 22.78664347,  29.39852083,  23.92583602,
      12.35083128, 25.52964636, 41.78519622, 18.18262047, 26.94975025, 24.70110386,  27.14280968,  15.25416206,
      23.56671608, 44.88177241, 38.00550997, 27.08095415, 50.65113443, 52.74192632,  34.61734664,  26.61358159,
      32.98654909, 9.606904408, 32.20135419, 34.74562824, 11.81521841, 10.83811219,  5.674239553,  17.69964142,
      62.81964564, 13.24037324, 50.32456591, 50.32456591, 13.24037324, 62.81964564,  17.69964142,  5.674239553,
      10.83811219, 11.81521841, 34.74562824, 32.20135419, 9.606904408, 32.98654909,  26.61358159,  34.61734664,
      52.74192632, 50.65113443, 20.73520402, 32.93719443, 48.2992652,  21.19114114,  30.89264227,  24.89771606,
      9.176015427, 20.27217738, 29.28691769, 15.03165356, 27.84318498, 34.68435991,  34.68435991,  27.84318498,
      15.03165356, 29.28691769, 20.27217738, 9.176015427, 24.89771606, 30.89264227,  21.19114114,  48.2992652,
      32.93719443, 20.73520402, 6.719673423, 17.64639443, 30.68090791, 15.46363667,  23.58019589,  20.06896303,
      39.86466148, 27.83970695, 12.83864635, 16.5836295,  13.44682578, 16.30245654,  16.30245654,  13.44682578,
      16.5836295,  12.83864635, 27.83970695, 39.86466148, 20.06896303, 23.58019589,  15.46363667,  30.68090791,
      17.64639443, 6.719673423, 27.12190306, 2.961662417, 25.25555306, 17.62778921,  22.62647205,  36.46771072,
      36.41291345, 11.50260765, 14.95878354, 21.88565217, 28.69185768, 36.83739298,  36.83739298,  28.69185768,
      21.88565217, 14.95878354, 11.50260765, 36.41291345, 36.46771072, 22.62647205,  17.62778921,  25.25555306,
      2.961662417, 27.12190306, 25.2939449,  17.32451202, 12.1347743,  25.57745107,  25.57745107,  12.1347743,
      17.32451202, 25.2939449,  44.17442509, 1.574050843, 24.4480595,  52.11685464,  11.25371431,  53.20105147,
      45.15880914, 36.38678262, 6.422398352, 28.00775101, 9.189605581, 0.8557792959, 13.1884991,   11.29297213,
      30.3615642,  22.29253595, 10.27159267, 39.68114611, 9.0530333,   23.64360774,  15.13274885,  18.5713053,
      15.76917237, 14.74082105, 14.74082105, 15.76917237, 18.5713053,  15.13274885,  23.64360774,  9.0530333,
      39.68114611, 10.27159267, 22.29253595, 30.3615642,  11.29297213, 13.1884991,   0.8557792959, 9.189605581,
      28.00775101, 6.422398352, 36.38678262, 45.15880914, 53.20105147, 11.25371431,  52.11685464,  24.4480595,
      1.574050843, 44.17442509, 27.9894974,  5.415396921, 3.735046095, 20.55352437,  76.7118663,   21.03118285,
      18.33800759, 13.27440504, 51.68177502, 10.886288,   25.15744523, 5.96704291,   5.96704291,   25.15744523,
      10.886288,   51.68177502, 13.27440504, 18.33800759, 21.03118285, 76.7118663,   20.55352437,  3.735046095,
      5.415396921, 27.9894974,  41.75047787, 17.99378669, 9.338950901, 30.6618937,   15.41701938,  68.10175603,
      25.3312221,  14.39577768, 12.49152746, 16.07039912, 9.45794789,  21.53452485,  28.65184481,  35.6898372,
      32.52542215, 21.77437533, 23.02671489, 16.5151115,  26.23054438, 29.48114551,  39.52044899,  4.838360356,
      15.7998075,  16.62403163, 16.62403163, 15.7998075,  4.838360356, 39.52044899,  29.48114551,  26.23054438,
      16.5151115,  23.02671489, 21.77437533, 32.52542215, 35.6898372,  28.65184481,  21.53452485,  9.45794789,
      16.07039912, 12.49152746, 14.39577768, 25.3312221,  68.10175603, 15.41701938,  30.6618937,   9.338950901,
      17.99378669, 41.75047787, 25.82771492, 42.10859089, 63.07824256, 28.83470644,  22.24442744,  28.3901066,
      42.37106543, 20.55535434, 9.863645588, 22.21047134, 15.70080799, 13.14507249,  17.34888667,  40.67473219,
      23.18903363, 29.11550879, 20.8391897,  7.247260973, 2.932829605, 22.05906284,  32.47840578,  12.28081365,
      39.57627886, 33.63458265, 14.52700906, 34.85544003, 19.6051306,  25.00155007,  18.47241552,  10.50584675,
      58.73341054, 21.71302478, 32.45140323, 29.59934056, 16.11536089, 14.03598289,  14.03598289,  16.11536089,
      29.59934056, 32.45140323, 21.71302478, 58.73341054, 10.50584675, 18.47241552,  25.00155007,  19.6051306,
      34.85544003, 14.52700906, 33.63458265, 39.57627886, 12.28081365, 32.47840578,  22.05906284,  2.932829605,
      7.247260973, 20.8391897,  29.11550879, 23.18903363, 40.67473219, 17.34888667,  13.14507249,  15.70080799,
      22.21047134, 9.863645588, 20.55535434, 42.37106543, 28.3901066,  22.24442744,  28.83470644,  63.07824256,
      42.10859089, 25.82771492, 23.53706564, 11.36185472, 13.28255343, 13.28255343,  11.36185472,  23.53706564,
      18.28557828, 28.40058949, 7.612326414, 22.11947313, 12.94986368, 23.17407632,  34.464379,    29.6288939,
      24.87003549, 17.8999986,  12.30209557, 19.00843322, 19.00843322, 12.30209557,  17.8999986,   24.87003549,
      29.6288939,  34.464379,   23.17407632, 12.94986368, 22.11947313, 7.612326414,  28.40058949,  18.28557828,
      19.66072578, 5.124230468, 48.99617149, 10.08075586, 34.66229356, 32.34339476,  10.4970495,   4.880787567,
      11.80773287, 23.24903369, 14.52608293, 14.63157956, 25.83363773, 10.32246319,  36.05696013,  17.3698187,
      27.8514048,  44.99234038, 24.41030223, 22.59644313, 23.16533397, 17.09147198,  19.12620513,  35.04273162,
      35.04273162, 19.12620513, 17.09147198, 23.16533397, 22.59644313, 24.41030223,  44.99234038,  27.8514048,
      17.3698187,  36.05696013, 10.32246319, 25.83363773, 14.63157956, 14.52608293,  23.24903369,  11.80773287,
      4.880787567, 10.4970495,  32.34339476, 34.66229356, 10.08075586, 48.99617149,  5.124230468,  19.66072578,
  };
  return sfk_e_e_expected;
}

typename StructureFactorTests::DataC StructureFactorTests::getRhoKElec()
{
  DataC rhok_e_expected = {
      {0.592406798, -1.491295186},    {3.584709528, -1.712368125},     {0.399798283, -3.005949682},
      {4.994471241, -5.147815188},    {4.994471241, 5.147815188},      {0.399798283, 3.005949682},
      {3.584709528, 1.712368125},     {0.592406798, 1.491295186},      {7.35951582, -5.679219609},
      {4.826218866, -5.896167806},    {3.279859285, -8.152435266},     {3.279859285, 8.152435266},
      {4.826218866, 5.896167806},     {7.35951582, 5.679219609},       {2.076227417, -3.606254855},
      {3.455819328, -9.61471789},     {-1.546549519, -3.149424913},    {6.734505637, 0.4296410754},
      {4.920218971, -1.791886372},    {11.15685334, -1.16643297},      {11.15685334, 1.16643297},
      {4.920218971, 1.791886372},     {6.734505637, -0.4296410754},    {-1.546549519, 3.149424913},
      {3.455819328, 9.61471789},      {2.076227417, 3.606254855},      {0.6491298846, -5.774231534},
      {-3.717649003, -2.715481216},   {0.2622958672, -8.464838415},    {0.8365136061, -5.196322223},
      {2.131132444, -9.120963381},    {7.443614204, 0.1272261529},     {-1.302274203, 2.78390178},
      {-2.805319493, -4.100622859},   {2.166298591, 2.167854305},      {8.253003166, 1.212442916},
      {3.100903101, 0.2963773422},    {-3.347834579, -2.253051752},    {-3.347834579, 2.253051752},
      {3.100903101, -0.2963773422},   {8.253003166, -1.212442916},     {2.166298591, -2.167854305},
      {-2.805319493, 4.100622859},    {-1.302274203, -2.78390178},     {7.443614204, -0.1272261529},
      {2.131132444, 9.120963381},     {0.8365136061, 5.196322223},     {0.2622958672, 8.464838415},
      {-3.717649003, 2.715481216},    {0.6491298846, 5.774231534},     {2.391165913, -4.354511371},
      {1.974771744, -7.41989072},     {0.4369552801, -1.177869446},    {3.464333342, -12.54276112},
      {3.464333342, 12.54276112},     {0.4369552801, 1.177869446},     {1.974771744, 7.41989072},
      {2.391165913, 4.354511371},     {3.54760182, -5.061825456},      {-3.484698012, -5.007374793},
      {-2.511083868, 1.34703759},     {-2.511083868, -1.34703759},     {-3.484698012, 5.007374793},
      {3.54760182, 5.061825456},      {-4.758557122, -1.422732684},    {1.031636721, -5.65727216},
      {-3.966058, -0.7569951138},     {-8.923606409, -5.387915635},    {4.195903639, -4.546900414},
      {4.829261752, 3.230756396},     {3.00703451, -5.985052738},      {-2.540018671, -6.998123915},
      {2.830959272, 1.483453125},     {1.639223839, 3.652082621},      {-4.786506892, 3.88408032},
      {2.714855164, 1.799382255},     {2.714855164, -1.799382255},     {-4.786506892, -3.88408032},
      {1.639223839, -3.652082621},    {2.830959272, -1.483453125},     {-2.540018671, 6.998123915},
      {3.00703451, 5.985052738},      {4.829261752, -3.230756396},     {4.195903639, 4.546900414},
      {-8.923606409, 5.387915635},    {-3.966058, 0.7569951138},       {1.031636721, 5.65727216},
      {-4.758557122, 1.422732684},    {-2.995440093, -1.522595608},    {-3.952925704, 0.7274383407},
      {-2.676473452, -2.648075271},   {2.056578256, -2.997203116},     {6.533462259, -3.822700937},
      {-1.989243991, -3.323825628},   {-2.446076959, 0.1415913832},    {-2.390803861, -1.153463723},
      {5.994254208, 0.5642015223},    {1.587407905, -5.109903138},     {2.812657793, 3.224537665},
      {0.4621462996, -0.6620321102},  {0.4621462996, 0.6620321102},    {2.812657793, -3.224537665},
      {1.587407905, 5.109903138},     {5.994254208, -0.5642015223},    {-2.390803861, 1.153463723},
      {-2.446076959, -0.1415913832},  {-1.989243991, 3.323825628},     {6.533462259, 3.822700937},
      {2.056578256, 2.997203116},     {-2.676473452, 2.648075271},     {-3.952925704, -0.7274383407},
      {-2.995440093, 1.522595608},    {-2.449538493, -3.938393781},    {-4.169156604, -1.420828885},
      {-1.119580507, -7.335045086},   {-3.066600802, -5.171130554},    {0.2932524973, 2.283789912},
      {4.478674004, -0.9375669032},   {-2.301423115, -4.09221705},     {0.4033449274, 7.406520527},
      {-5.539294787, -4.483272232},   {1.817272465, -4.938120778},     {-1.283513076, -1.526913966},
      {-5.36869316, 0.6403014546},    {-5.36869316, -0.6403014546},    {-1.283513076, 1.526913966},
      {1.817272465, 4.938120778},     {-5.539294787, 4.483272232},     {0.4033449274, -7.406520527},
      {-2.301423115, 4.09221705},     {4.478674004, 0.9375669032},     {0.2932524973, -2.283789912},
      {-3.066600802, 5.171130554},    {-1.119580507, 7.335045086},     {-4.169156604, 1.420828885},
      {-2.449538493, 3.938393781},    {-5.006932432, -0.8101500245},   {-2.349720169, -4.534374178},
      {-3.258060361, -6.563597928},   {-5.269822396, 5.625207649},     {-1.056858806, -1.715591085},
      {6.134076968, 1.376995278},     {2.943460611, 1.621194225},      {1.507924639, -1.258411608},
      {-8.943758932, -2.031447357},   {-0.2633985137, -2.200559112},   {-1.154778987, -2.864115247},
      {3.757407189, -0.1391363848},   {5.542543097, -2.473003635},     {-2.582678602, 1.947651329},
      {1.331840432, -0.4289061372},   {-0.5679093939, -5.896474543},   {-0.5679093939, 5.896474543},
      {1.331840432, 0.4289061372},    {-2.582678602, -1.947651329},    {5.542543097, 2.473003635},
      {3.757407189, 0.1391363848},    {-1.154778987, 2.864115247},     {-0.2633985137, 2.200559112},
      {-8.943758932, 2.031447357},    {1.507924639, 1.258411608},      {2.943460611, -1.621194225},
      {6.134076968, -1.376995278},    {-1.056858806, 1.715591085},     {-5.269822396, -5.625207649},
      {-3.258060361, 6.563597928},    {-2.349720169, 4.534374178},     {-5.006932432, 0.8101500245},
      {-4.24255231, -0.1480280499},   {3.143919972, -5.239215144},     {-3.501534887, 1.262224944},
      {4.789734698, 1.410612351},     {0.4787001977, 3.037797639},     {2.685521759, 2.97980471},
      {2.685521759, -2.97980471},     {0.4787001977, -3.037797639},    {4.789734698, -1.410612351},
      {-3.501534887, -1.262224944},   {3.143919972, 5.239215144},      {-4.24255231, 0.1480280499},
      {-7.380678066, -2.085383706},   {-8.816466109, 2.135007181},     {-3.966232505, -10.40109555},
      {-3.992069887, -2.509440937},   {-1.813708042, -3.303717474},    {-4.318100914, 1.254589646},
      {7.517474013, -0.8839434329},   {1.476300926, 0.358348573},      {-1.905166984, -1.170186506},
      {2.860050335, -1.935362053},    {-6.622911753, 1.248440663},     {-3.721973617, -0.6532077262},
      {5.397538518, -0.5902887119},   {3.959158336, 2.642083766},      {0.2132040375, 2.653470909},
      {-0.5940686958, 1.017178234},   {1.364157636, -2.555690312},     {4.447149791, 3.147212206},
      {-2.467632173, -7.81071708},    {1.24870552, 3.042326478},       {-1.87676403, -1.636112745},
      {4.225338673, 8.041012543},     {1.95879835, -2.829085504},      {-0.5199405703, -3.344744312},
      {-0.5199405703, 3.344744312},   {1.95879835, 2.829085504},       {4.225338673, -8.041012543},
      {-1.87676403, 1.636112745},     {1.24870552, -3.042326478},      {-2.467632173, 7.81071708},
      {4.447149791, -3.147212206},    {1.364157636, 2.555690312},      {-0.5940686958, -1.017178234},
      {0.2132040375, -2.653470909},   {3.959158336, -2.642083766},     {5.397538518, 0.5902887119},
      {-3.721973617, 0.6532077262},   {-6.622911753, -1.248440663},    {2.860050335, 1.935362053},
      {-1.905166984, 1.170186506},    {1.476300926, -0.358348573},     {7.517474013, 0.8839434329},
      {-4.318100914, -1.254589646},   {-1.813708042, 3.303717474},     {-3.992069887, 2.509440937},
      {-3.966232505, 10.40109555},    {-8.816466109, -2.135007181},    {-7.380678066, 2.085383706},
      {-2.299573226, 6.924648483},    {-4.531123402, -2.911786594},    {-3.442322069, -3.39095917},
      {-5.42771034, 0.8670229623},    {-1.383381222, -2.301335509},    {-1.270652673, 0.8065787485},
      {-0.1855711587, -8.051383619},  {1.988225715, -8.346244765},     {1.000589918, 2.997004988},
      {-3.695016123, 1.74461724},     {1.796915956, 1.00103223},       {-3.909689116, -0.09522796128},
      {-1.423160253, -2.237793001},   {2.2219887, -1.751197772},       {2.17689576, 10.40933387},
      {2.17689576, -10.40933387},     {2.2219887, 1.751197772},        {-1.423160253, 2.237793001},
      {-3.909689116, 0.09522796128},  {1.796915956, -1.00103223},      {-3.695016123, -1.74461724},
      {1.000589918, -2.997004988},    {1.988225715, 8.346244765},      {-0.1855711587, 8.051383619},
      {-1.270652673, -0.8065787485},  {-1.383381222, 2.301335509},     {-5.42771034, -0.8670229623},
      {-3.442322069, 3.39095917},     {-4.531123402, 2.911786594},     {-2.299573226, -6.924648483},
      {-2.809274407, -1.8579053},     {-1.798467547, 1.354139585},     {-4.597633615, -5.219009215},
      {-0.7874598068, -4.425063848},  {6.0195082, -0.3360570266},      {-7.235886266, -1.991595514},
      {1.992164338, 3.124241117},     {-0.07142873284, 3.503326493},   {-1.178474547, 3.673951749},
      {-3.244168323, -1.830077893},   {-4.368251933, -3.369634613},    {-0.3029959504, -3.641767663},
      {-0.3029959504, 3.641767663},   {-4.368251933, 3.369634613},     {-3.244168323, 1.830077893},
      {-1.178474547, -3.673951749},   {-0.07142873284, -3.503326493},  {1.992164338, -3.124241117},
      {-7.235886266, 1.991595514},    {6.0195082, 0.3360570266},       {-0.7874598068, 4.425063848},
      {-4.597633615, 5.219009215},    {-1.798467547, -1.354139585},    {-2.809274407, 1.8579053},
      {-0.7689257185, 2.003687953},   {1.213473957, 5.054683181},      {3.96667443, -4.71513151},
      {3.606040459, 0.1961809201},    {-5.423399108, 3.434874185},     {2.249716171, -0.321927977},
      {3.88014528, 6.799582179},      {-0.4653070824, 0.6773665182},   {-4.861488694, 3.035141588},
      {-2.970815833, 1.34691903},     {1.454137184, 3.225546259},      {-2.470089619, -1.489483054},
      {-2.470089619, 1.489483054},    {1.454137184, -3.225546259},     {-2.970815833, -1.34691903},
      {-4.861488694, -3.035141588},   {-0.4653070824, -0.6773665182},  {3.88014528, -6.799582179},
      {2.249716171, 0.321927977},     {-5.423399108, -3.434874185},    {3.606040459, -0.1961809201},
      {3.96667443, 4.71513151},       {1.213473957, -5.054683181},     {-0.7689257185, -2.003687953},
      {-2.220049985, 1.512345934},    {-1.235954911, 0.7785846187},    {-5.846999645, -0.01472071938},
      {-4.717792777, 1.951825527},    {-3.773251234, -4.9900085},      {2.884653931, 3.398807743},
      {5.672744372, 0.787344791},     {4.248656017, 2.139426899},      {-4.828886929, 0.4608908982},
      {-4.072752682, 1.278637543},    {0.2896719136, 0.2327966304},    {3.294310923, -1.094228265},
      {3.294310923, 1.094228265},     {0.2896719136, -0.2327966304},   {-4.072752682, -1.278637543},
      {-4.828886929, -0.4608908982},  {4.248656017, -2.139426899},     {5.672744372, -0.787344791},
      {2.884653931, -3.398807743},    {-3.773251234, 4.9900085},       {-4.717792777, -1.951825527},
      {-5.846999645, 0.01472071938},  {-1.235954911, -0.7785846187},   {-2.220049985, -1.512345934},
      {0.9226881039, 4.267571517},    {-1.437252509, -3.580346254},    {0.03603471236, -1.27511536},
      {-5.739364373, -0.109743273},   {-5.739364373, 0.109743273},     {0.03603471236, 1.27511536},
      {-1.437252509, 3.580346254},    {0.9226881039, -4.267571517},    {-5.211255342, 7.146559907},
      {-0.2306151078, -0.5819836338}, {-5.175352924, -0.2336025647},   {-0.2841681075, -10.69448026},
      {-2.390393553, -0.7063818584},  {1.107914962, -1.777668095},     {4.157074405, 6.030434262},
      {5.721280227, -5.000397836},    {-4.010330302, -1.533930447},    {6.430809793, 0.4185511678},
      {-1.039620376, 4.58929113},     {-0.6967155093, -0.09597996132}, {4.601202499, 0.616736122},
      {2.036152359, 3.429550053},     {-6.305119284, -1.457079695},    {-2.729853685, 3.902248331},
      {3.36438765, 1.030714618},      {-1.500014677, -4.306188528},    {2.573007947, 2.296425084},
      {6.217131676, 3.523376411},     {3.895629486, -0.6999141065},    {2.557151377, -6.427190985},
      {-2.97872992, 4.799777566},     {-4.733330706, -0.2710847219},   {-4.733330706, 0.2710847219},
      {-2.97872992, -4.799777566},    {2.557151377, 6.427190985},      {3.895629486, 0.6999141065},
      {6.217131676, -3.523376411},    {2.573007947, -2.296425084},     {-1.500014677, 4.306188528},
      {3.36438765, -1.030714618},     {-2.729853685, -3.902248331},    {-6.305119284, 1.457079695},
      {2.036152359, -3.429550053},    {4.601202499, -0.616736122},     {-0.6967155093, 0.09597996132},
      {-1.039620376, -4.58929113},    {6.430809793, -0.4185511678},    {-4.010330302, 1.533930447},
      {5.721280227, 5.000397836},     {4.157074405, -6.030434262},     {1.107914962, 1.777668095},
      {-2.390393553, 0.7063818584},   {-0.2841681075, 10.69448026},    {-5.175352924, 0.2336025647},
      {-0.2306151078, 0.5819836338},  {-5.211255342, -7.146559907},    {-6.729282937, 0.1392473302},
      {-1.508695167, -0.75611098},    {-1.462483193, 0.6218986152},    {-0.3212649158, -0.7247357119},
      {8.637510488, 0.7257245863},    {-2.54471011, -4.587263955},     {-1.740905917, -3.925169868},
      {-0.9631188028, 1.153119105},   {-3.088903107, 8.718104082},     {-0.1584290231, 2.498698288},
      {4.214175806, -1.945541303},    {-3.31113648, 0.9504815628},     {-3.31113648, -0.9504815628},
      {4.214175806, 1.945541303},     {-0.1584290231, -2.498698288},   {-3.088903107, -8.718104082},
      {-0.9631188028, -1.153119105},  {-1.740905917, 3.925169868},     {-2.54471011, 4.587263955},
      {8.637510488, -0.7257245863},   {-0.3212649158, 0.7247357119},   {-1.462483193, -0.6218986152},
      {-1.508695167, 0.75611098},     {-6.729282937, -0.1392473302},   {-3.408021656, 8.709178999},
      {-1.891611669, 6.44436254},     {-1.367061208, -2.100065892},    {-0.02526274221, -2.68308627},
      {0.2004189036, -0.8899217728},  {7.097950078, -0.2332078497},    {-3.520216696, -2.698537345},
      {-1.002585137, 0.08162308103},  {2.158168023, -0.144596563},     {-2.015705281, 3.501098672},
      {3.243088509, -1.314268813},    {2.642816236, 4.411320139},      {3.285915403, -6.027933385},
      {2.156584325, 0.4628729323},    {3.525612941, 5.440950026},      {-2.358661202, -2.249559541},
      {-0.4583178929, 2.501486706},   {-0.4247704512, 0.7248216483},   {1.228833828, -0.3453960927},
      {-0.4787313482, 8.11094345},    {-4.417644143, 3.435177791},     {-0.3485159775, 1.372374762},
      {-0.207369571, -0.07035884482}, {-3.711929499, -0.3703085192},   {-3.711929499, 0.3703085192},
      {-0.207369571, 0.07035884482},  {-0.3485159775, -1.372374762},   {-4.417644143, -3.435177791},
      {-0.4787313482, -8.11094345},   {1.228833828, 0.3453960927},     {-0.4247704512, -0.7248216483},
      {-0.4583178929, -2.501486706},  {-2.358661202, 2.249559541},     {3.525612941, -5.440950026},
      {2.156584325, -0.4628729323},   {3.285915403, 6.027933385},      {2.642816236, -4.411320139},
      {3.243088509, 1.314268813},     {-2.015705281, -3.501098672},    {2.158168023, 0.144596563},
      {-1.002585137, -0.08162308103}, {-3.520216696, 2.698537345},     {7.097950078, 0.2332078497},
      {0.2004189036, 0.8899217728},   {-0.02526274221, 2.68308627},    {-1.367061208, 2.100065892},
      {-1.891611669, -6.44436254},    {-3.408021656, -8.709178999},    {3.421065653, 5.95135339},
      {-7.250908142, 4.418667041},    {-4.982302745, -7.652168385},    {-5.363657005, 1.124083756},
      {1.850622328, -2.512520559},    {0.9868845851, -1.311419734},    {-1.627539269, 5.462132253},
      {-1.400040134, 1.869893027},    {-3.990865817, 1.102683091},     {-1.567844672, 3.67151263},
      {2.337050097, -5.629459035},    {1.300172468, 0.7606942941},     {5.249089835, -2.353762846},
      {8.343988604, -0.8481884228},   {-0.2356472914, 2.200821018},    {6.950581555, -1.243846454},
      {2.125556836, 3.765840528},     {1.35271916, -0.7274177627},     {0.9406424229, 1.451027264},
      {-2.119029197, -1.426777576},   {4.983770388, 6.636555814},      {-2.008725517, 3.623922395},
      {-4.296545309, -0.5656753318},  {2.036823439, 1.873586424},      {4.993508346, -2.385104517},
      {6.786094192, -5.275563531},    {1.594318128, -0.8120991502},    {-1.633011809, 1.467880629},
      {-1.502656956, -2.871359412},   {-1.652388013, 2.130237304},     {6.521933219, 4.971187201},
      {6.083207038, 1.231322834},     {-1.63499172, -6.445316399},     {3.135819197, 2.2744509},
      {-1.000563576, 6.159609873},    {-4.145614776, -0.2669631771},   {-4.145614776, 0.2669631771},
      {-1.000563576, -6.159609873},   {3.135819197, -2.2744509},       {-1.63499172, 6.445316399},
      {6.083207038, -1.231322834},    {6.521933219, -4.971187201},     {-1.652388013, -2.130237304},
      {-1.502656956, 2.871359412},    {-1.633011809, -1.467880629},    {1.594318128, 0.8120991502},
      {6.786094192, 5.275563531},     {4.993508346, 2.385104517},      {2.036823439, -1.873586424},
      {-4.296545309, 0.5656753318},   {-2.008725517, -3.623922395},    {4.983770388, -6.636555814},
      {-2.119029197, 1.426777576},    {0.9406424229, -1.451027264},    {1.35271916, 0.7274177627},
      {2.125556836, -3.765840528},    {6.950581555, 1.243846454},      {-0.2356472914, -2.200821018},
      {8.343988604, 0.8481884228},    {5.249089835, 2.353762846},      {1.300172468, -0.7606942941},
      {2.337050097, 5.629459035},     {-1.567844672, -3.67151263},     {-3.990865817, -1.102683091},
      {-1.400040134, -1.869893027},   {-1.627539269, -5.462132253},    {0.9868845851, 1.311419734},
      {1.850622328, 2.512520559},     {-5.363657005, -1.124083756},    {-4.982302745, 7.652168385},
      {-7.250908142, -4.418667041},   {3.421065653, -5.95135339},      {-2.053163131, -1.063464961},
      {-1.678143372, 3.762696395},    {0.0007866869675, 1.058095833},  {0.0007866869675, -1.058095833},
      {-1.678143372, -3.762696395},   {-2.053163131, 1.063464961},     {2.298223742, 1.357939852},
      {2.836386156, 5.724801754},     {-0.5488724262, -1.980868818},   {1.778633565, 2.762895138},
      {2.980702348, 1.138034073},     {-3.4942026, -1.180358634},      {3.874499746, -1.153232635},
      {5.613769185, -6.254772222},    {-2.863877135, 3.081432594},     {0.6554451206, 4.137321163},
      {4.995420314, -0.2541026675},   {4.070608562, -4.396871913},     {4.070608562, 4.396871913},
      {4.995420314, 0.2541026675},    {0.6554451206, -4.137321163},    {-2.863877135, -3.081432594},
      {5.613769185, 6.254772222},     {3.874499746, 1.153232635},      {-3.4942026, 1.180358634},
      {2.980702348, -1.138034073},    {1.778633565, -2.762895138},     {-0.5488724262, 1.980868818},
      {2.836386156, -5.724801754},    {2.298223742, -1.357939852},     {3.674339196, 1.130651844},
      {0.0348732107, 0.7331409485},   {-8.700890383, 2.006820821},     {-0.03683957247, -4.234908131},
      {0.9849899308, -4.404792991},   {0.1247196684, 3.179279889},     {0.0411652183, -1.996882442},
      {-1.239305257, 1.285632629},    {3.913104959, 1.040016747},      {3.921497899, -0.4837490399},
      {-1.704045238, -1.159308846},   {3.971211896, 1.024632384},      {2.514078524, -4.36041809},
      {0.7877755588, 2.334749544},    {2.225466536, 2.114656851},      {0.8446410302, -1.650654313},
      {-2.096785216, 0.8956639147},   {-11.17575533, 1.761610194},     {-2.918525442, 5.771690392},
      {-1.136338954, 1.452676212},    {-2.780081271, -4.580619689},    {0.2019475458, -1.723826209},
      {-1.154288703, 3.912902228},    {-1.566893672, 5.624962971},     {-1.566893672, -5.624962971},
      {-1.154288703, -3.912902228},   {0.2019475458, 1.723826209},     {-2.780081271, 4.580619689},
      {-1.136338954, -1.452676212},   {-2.918525442, -5.771690392},    {-11.17575533, -1.761610194},
      {-2.096785216, -0.8956639147},  {0.8446410302, 1.650654313},     {2.225466536, -2.114656851},
      {0.7877755588, -2.334749544},   {2.514078524, 4.36041809},       {3.971211896, -1.024632384},
      {-1.704045238, 1.159308846},    {3.921497899, 0.4837490399},     {3.913104959, -1.040016747},
      {-1.239305257, -1.285632629},   {0.0411652183, 1.996882442},     {0.1247196684, -3.179279889},
      {0.9849899308, 4.404792991},    {-0.03683957247, 4.234908131},   {-8.700890383, -2.006820821},
      {0.0348732107, -0.7331409485},  {3.674339196, -1.130651844},
  };
  return rhok_e_expected;
}

} // namespace qmcplusplus
